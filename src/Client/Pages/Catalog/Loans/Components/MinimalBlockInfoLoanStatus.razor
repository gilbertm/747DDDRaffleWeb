@if (Loan != default)
{
    LoanApplicantDto loanApplicant = default!;

    if (Loan.LoanApplicants != default)
    {
        if (Loan.LoanApplicants.Count > 0)
        {
            loanApplicant = Loan.LoanApplicants.FirstOrDefault(la => la.AppUserId.Equals(AppUserId)) ?? default!;
        }
    }


    @if (Loan.Status != default && Loan.Status > LoanStatus.Draft)
    {
        if (Role.Equals("Lessee"))
        {
            if (Loan.Status.Equals(LoanStatus.Published))
            {
                if (CanApply && !(loanApplicant is { }))
                {
                    if (Loan.Status.Equals(LoanStatus.Published))
                    {
                        <MudGrid>
                            <MudItem xs="6">
                                <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.PlayArrow" IconColor="Color.Surface" Size="Size.Small" OnClick="(() => Apply())">Apply</MudButton>
                            </MudItem>
                            <MudItem xs="6">
                                <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.PlayArrow" IconColor="Color.Surface" Size="Size.Small" Href="@Href">Details</MudButton>
                            </MudItem>
                        </MudGrid>
                    }

                }
                else
                {
                    <MudGrid>
                        <MudItem xs="12" Class="py-0">
                            <MudButton Variant="Variant.Filled" FullWidth="true" Class="text-center full-width py-3" EndIcon="@Icons.Filled.RemoveRedEye" IconColor="Color.Success" Size="Size.Small" Href="@Href">View</MudButton>
                        </MudItem>
                        <MudItem xs="12" Class="py-0">
                            @if (loanApplicant != default)
                            {
                                switch (loanApplicant.Flag)
                                {
                                    case 1:
                                        <MudText Typo="Typo.caption">You are not allowed on this loan</MudText>
                                        break;
                                    case 2:
                                        @*TODO:// Maybe in the future add the functionality of re-apply for this loan; the lessee is not blocked anyways. Business rules should apply*@
                                        <MudText Typo="Typo.caption">You applied but removed yourself from this Loan.</MudText>
                                        <MudButton Variant="Variant.Text" Class="d-inline" OnClick="(() => ReApply())"><MudText Typo="Typo.caption">Reapply?</MudText></MudButton>
                                        break;
                                    case 3:
                                        @*TODO:// Maybe in the future add the functionality of re-apply for this loan; the lessee is not blocked anyways. Business rules should apply*@
                                        <MudText Typo="Typo.caption">The Lender removed you from applying from loan.</MudText>
                                        break;
                                    case 400:
                                        @*Lender blocked you from applying this loan*@
                                        <MudAlert Severity="Severity.Error">Declined. You are declined, you can not do anything with this listing. For whatever reasons, please proceed with dispute process, if you need to.</MudAlert>
                                        break;

                                    default:
                                        if (loanApplicant is { })
                                        {
                                            switch (Loan.Status)
                                            {
                                                case LoanStatus.Assigned:
                                                    <MudContainer MaxWidth="MaxWidth.Large" Class="text-center">
                                                        <MudIcon Icon="@Icons.Material.Filled.SentimentSatisfied" Title="Assigned" Color="Color.Success" Size="Size.Small" /> <MudText Typo="Typo.button">Awarded</MudText>
                                                        <MudTooltip Text="You are the lessee of this loan.">
                                                            <MudIconButton Size="Size.Small" Icon="@Icons.Material.Outlined.Info" Style="@($"color:{Colors.Grey.Darken3};")" />
                                                        </MudTooltip>

                                                    </MudContainer>
                                                    break;
                                                default:
                                                    <MudContainer MaxWidth="MaxWidth.Large" Class="text-center">
                                                        <MudGrid>
                                                            <MudItem xs="12" Class="pt-2 pb-0">
                                                                <MudText Typo="Typo.h6" class="d-inline" Style="@($"color:{Colors.Amber.Accent4}")">Applied</MudText>
                                                                <MudText Typo="Typo.caption" Style="@($"color:{Colors.BlueGrey.Darken1}")">
                                                                    @if (Loan != default)
                                                                    {
                                                                        if (Loan.LoanApplicants != default)
                                                                        {
                                                                            <text>[@($"+{Loan.LoanApplicants.Count} other(s)")]</text>
                                                                        }
                                                                    }

                                                                </MudText>
                                                            </MudItem>
                                                            <MudItem xs="12">
                                                                <MudButton OnClick="(() => CancelApply())" EndIcon="@Icons.TwoTone.Cancel" Size="Size.Small" Color="Color.Warning">Cancel</MudButton><br />
                                                                <MudTooltip Text="If you wish to cancel your application, click action. Awaiting lender's acceptance and approval.">
                                                                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Outlined.Info" Style="@($"color:{Colors.Grey.Darken3};")" />
                                                                </MudTooltip>
                                                            </MudItem>
                                                        </MudGrid>

                                                    </MudContainer>
                                                    break;
                                            }
                                        }
                                        break;
                                }

                            }
                        </MudItem>
                    </MudGrid>
                }
            }

        }
    }
    else
    {
        <MudButton Variant="Variant.Outlined" Class="mt-2 mx-auto" StartIcon="@Icons.Material.Filled.PlayArrow" IconColor="Color.Success" Size="Size.Medium" Href="@Href">Apply</MudButton>
    }
}