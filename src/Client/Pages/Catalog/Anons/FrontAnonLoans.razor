@page "/catalog/front/loans/anon"
@attribute [AllowAnonymous]
@using System.Globalization
@using EHULOG.BlazorWebAssembly.Client.Components.EntityContainer
@using EHULOG.BlazorWebAssembly.Client.Pages.Catalog.Loans
@using Nager.Country

<MudContainer MaxWidth="MaxWidth.Large" Class="map-loan-slider pa-0">
    <MudGrid Justify="Justify.Center">
        <MudItem xs="12" md="6" Class="pt-0 pr-0">
            <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
                <MudTabPanel>
                    <ChildContent>
                        <MudText Typo="Typo.h5" Class="pb-2 text-center" Color="Color.Surface" Style="@($"color:{Colors.BlueGrey.Darken4};font-weight:700")">How much do you need?</MudText>
                        <MudContainer>
                            <MudGrid Class="borrower-borrowing-amount">
                                <MudItem xs="6" Class="mb-0 pb-0">
                                    <MudText Typo="Typo.h6" Style="font-weight:700">I am borrowing</MudText>
                                </MudItem>
                                <MudItem xs="6" Class="mb-0 pb-0" Style="text-align:right">
                                    <MudText Typo="Typo.h6" Style="font-weight:700">
                                        @($"{string.Format("{0:#,0.00}", float.Parse(Borrowing.ToString()))} {AppDataService.CountryCurrency}")
                                    </MudText>
                                </MudItem>
                                <MudItem xs="12" Class="py-0">
                                    <MudSlider @bind-Value="Borrowing" Size="Size.Large" Step="500" Min="500" Max="5000" Color="Color.Info" />
                                </MudItem>
                                <MudItem xs="6" Class="mt-0 pt-0">
                                    <MudText Typo="Typo.caption">
                                        @($"{string.Format("{0:#,0.00}", 500)} {AppDataService.CountryCurrency}")
                                    </MudText>
                                </MudItem>
                                <MudItem xs="6" Class="mt-0 pt-0" Style="text-align:right">
                                    <MudText Typo="Typo.caption">
                                        @($"{string.Format("{0:#,0.00}", 5000)} {AppDataService.CountryCurrency}")
                                    </MudText>
                                </MudItem>
                            </MudGrid>
                        </MudContainer>
                        <MudContainer>
                            <MudGrid Class="borrower-borrowing-months">
                                <MudItem xs="6" Class="mb-0 pb-0">
                                    <MudText Typo="Typo.h6" Style="font-weight:700">Borrow duration</MudText>
                                </MudItem>
                                <MudItem xs="6" Class="mb-0 pb-0" Style="text-align:right">
                                    <MudText Typo="Typo.h6" Style="font-weight:700">
                                        @BorrowDuration.ToString() Month@(BorrowDuration <= 1 ? "" : "s")
                                    </MudText>
                                </MudItem>
                                <MudItem xs="12" Class="py-0">
                                    <MudSlider @bind-Value="BorrowDuration" Size="Size.Large" Step="1" Min="1" Max="6" Color="Color.Info" />
                                </MudItem>
                                <MudItem xs="6" Class="mt-0 pt-0">
                                    <MudText Typo="Typo.caption">1 Month</MudText>
                                </MudItem>
                                <MudItem xs="6" Class="mt-0 pt-0" Style="text-align:right">
                                    <MudText Typo="Typo.caption">
                                        6 Months
                                    </MudText>
                                </MudItem>
                            </MudGrid>
                        </MudContainer>
                        <MudContainer Class="pt-4">
                            <SelfRegister IsFieldsOnly=true />
                        </MudContainer>
                    </ChildContent>
                    <TabContent>
                        <MudText Typo="Typo.h5" Class="py-3" Color="Color.Surface" Style="@($"color:{Colors.BlueGrey.Darken4}")">Borrower</MudText>
                    </TabContent>
                </MudTabPanel>
                <MudTabPanel>
                    <ChildContent>
                        <MudText Typo="Typo.h5" Class="py-3 text-center" Color="Color.Surface" Style="@($"color:{Colors.BlueGrey.Darken4};font-weight:700")">How much will be your return for being a do-gooder?</MudText>
                        <MudGrid Class="py-7">
                            <MudItem xs="12" md="6">
                                <MudPaper Elevation="0">
                                    <MudGrid Class="lender-loaning-amount">
                                        <MudItem xs="8" Class="mb-0 pb-0">
                                            <MudText Typo="Typo.subtitle1" Style="font-weight:700">Loan this amount</MudText>
                                        </MudItem>
                                        <MudItem xs="4" Class="mb-0 pb-0" Style="text-align:right">
                                            <MudText Typo="Typo.subtitle1" Style="font-weight:700;white-space:nowrap;">
                                                @($"{string.Format("{0:#,0.00}", float.Parse(Loaning.ToString()))} {AppDataService.CountryCurrency}")
                                            </MudText>
                                        </MudItem>
                                        <MudItem xs="12" Class="py-0">
                                            <MudSlider @bind-Value="Loaning" Size="Size.Medium" Step="500" Min="500" Max="5000" Color="Color.Info" />
                                        </MudItem>
                                        <MudItem xs="6" Class="mt-0 pt-0">
                                            <MudText Typo="Typo.caption">@($"{string.Format("{0:#,0.00}", 500)} {AppDataService.CountryCurrency}")</MudText>
                                        </MudItem>
                                        <MudItem xs="6" Class="mt-0 pt-0" Style="text-align:right">
                                            <MudText Typo="Typo.caption">
                                                    @($"{string.Format("{0:#,0.00}", 5000)} {AppDataService.CountryCurrency}")
                                            </MudText>
                                        </MudItem>
                                    </MudGrid>
                                </MudPaper>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudPaper Elevation="0">
                                    <MudGrid Class="lender-loaning-months">
                                        <MudItem xs="8" Class="mb-0 pb-0">
                                            <MudText Typo="Typo.subtitle1" Style="font-weight:700">Borrow duration</MudText>
                                        </MudItem>
                                        <MudItem xs="4" Class="mb-0 pb-0" Style="text-align:right">
                                            <MudText Typo="Typo.subtitle1" Style="font-weight:700">
                                                @LoaningDuration.ToString() Month@(LoaningDuration <= 1 ? "" : "s")
                                            </MudText>
                                        </MudItem>
                                        <MudItem xs="12" Class="py-0">
                                            <MudSlider @bind-Value="LoaningDuration" Size="Size.Large" Step="1" Min="1" Max="6" Color="Color.Info" />
                                        </MudItem>
                                        <MudItem xs="6" Class="mt-0 pt-0">
                                            <MudText Typo="Typo.caption">1 Month</MudText>
                                        </MudItem>
                                        <MudItem xs="6" Class="mt-0 pt-0" Style="text-align:right">
                                            <MudText Typo="Typo.caption">
                                                6 Months
                                            </MudText>
                                        </MudItem>
                                    </MudGrid>

                                </MudPaper>

                            </MudItem>
                            <MudItem xs="12">
                                <SelfRegister IsFieldsOnly=true />
                            </MudItem>
                        </MudGrid>
                    </ChildContent>
                    <TabContent>
                        <MudText Typo="Typo.h5" Class="py-3" Color="Color.Surface" Style="@($"color:{Colors.BlueGrey.Darken4}")">Lender</MudText>
                    </TabContent>
                </MudTabPanel>
            </MudTabs>
        </MudItem>
        <MudItem xs="12" md="6">
            @if (Context != default)
            {
                <DynamicMapLoad IsMapOnly=true />
            }
        </MudItem>
    </MudGrid>
</MudContainer>

<MudContainer MaxWidth="MaxWidth.Large" Class="loan-listing my-5 pa-0">
    <MudGrid>
        @if (Context != default)
        {
            <MudItem xs="12">
                <EntityContainer TEntity="LoanDto" Context="@Context"></EntityContainer>
            </MudItem>
        }
        else
        {
            <MudItem xs="12" Class="text-center justify-content-center">
                <MudPaper>
                    <MudText Typo="Typo.h5" Class="mt-5" Style="@($"color:{Colors.Yellow.Darken1};")">Seems like this location isn't helping those who are in need. Be the <MudLink Href="#" Typo="Typo.h5" Class="mt-5" Color="Color.Primary">first</MudLink>?</MudText>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>
</MudContainer>

@code {
    private int Borrowing { get; set; } = 500;
    private int BorrowDuration { get; set; } = 1;
    private int Loaning { get; set; } = 500;
    private int LoaningDuration { get; set; } = 1;
    private bool IsVisibleOverlay = false;

    private IDictionary<Guid, bool> dictOverlayVisibility = new Dictionary<Guid, bool>();

    public void IsVisibleProductOverlay(Guid guid)
    {
        dictOverlayVisibility[guid] = !dictOverlayVisibility[guid];
        StateHasChanged();
    }

    protected RenderFragment<LoanDto> BodyTemplate => trail => __builder =>
    {
        LoanLesseeDto _loanLesseeDto = default!;
        LoanLenderDto _loanLenderDto = default!;
        List<LoanLedgerDto> _loanLedgers = default!;
        float _sumLoan = 0f;
        string _currency = string.Empty;

        string _imageUrl = string.Empty;
        string _productName = string.Empty;
        string href = "/loan/" + @trail.Id + "?redirect_url=/login";

        if (trail.LoanLenders is { })
        {
            _loanLenderDto = trail.LoanLenders?.FirstOrDefault() ?? default!;
            _imageUrl = string.IsNullOrEmpty(trail.LoanLenders?.FirstOrDefault()?.Product?.Image?.ImagePath) ? string.Empty : (Config[ConfigNames.ApiBaseUrl] + trail.LoanLenders?.First().Product?.Image?.ImagePath);
            _productName = trail.LoanLenders?.FirstOrDefault()?.Product?.Name ?? string.Empty;
            var regions = CultureInfo.GetCultures(CultureTypes.SpecificCultures).Select(x => new RegionInfo(x.LCID));

            if (_loanLenderDto is { } && !(_loanLenderDto.LenderId == default))
            {
                if (_loanLenderDto.Lender is { } && !string.IsNullOrEmpty(_loanLenderDto.Lender.HomeCountry))
                {
                    var countryProvider = new CountryProvider();
                    var countryInfo = countryProvider.GetCountryByName(_loanLenderDto.Lender.HomeCountry);

                    if (countryInfo is { })
                    {
                        if (countryInfo.Currencies.Count() > 0)
                        {
                            _currency = countryInfo.Currencies.FirstOrDefault()?.IsoCode ?? string.Empty;
                        }

                    }
                }
            }
        }

        if (trail.LoanLessees is { })
        {
            _loanLesseeDto = trail.LoanLessees?.Where(l => l.LoanId.Equals(trail.Id)).FirstOrDefault() ?? default!;
        }

        if (trail.Ledgers is { })
        {
            _loanLedgers = trail.Ledgers?.ToList() ?? default!;

            if (!(_loanLedgers.Equals(default)))
            {
                _sumLoan = _loanLedgers.Sum(l => l.AmountDue);
            }
        }


        <MudCard Class="product" Style="@($"background:{Colors.Grey.Lighten2};position:relative")">
            <MudCardContent Class="pa-0">
                <MudCardHeader Class="py-2">
                    <MudImage Fluid="true" Src="@_imageUrl" Alt="@_productName" Class="rounded-lg" />
                </MudCardHeader>
                <MudCardContent Class="text-center rounded-t-lg rounded-b" Style="@($"background:{Colors.Shades.White}")">
                    @if (_loanLenderDto != default)
                    {
                        @if (_loanLenderDto.Product != default)
                        {
                            <MudText Typo="Typo.h1" Class="title">@_loanLenderDto.Product.Name</MudText>
                        }
                    }

                    <MudToolBar Class="px-0" Style="height:auto">
                        <MudText Typo="Typo.h2" Class="text-left product-price">@string.Format("{0:#,0.00}", _sumLoan) @_currency</MudText>
                        <MudSpacer />
                        @if (trail.LoanApplicants != default)
                        {
                            <MudAlert Severity="Severity.Normal" Icon="@Icons.Material.Filled.Person" Dense="true" Class="ma-0 pa-0 border-0" Variant="Variant.Outlined">@trail.LoanApplicants.Count()</MudAlert>
                        }
                    </MudToolBar>
                    <MudToolBar Class="px-0" Style="height:auto">
                        <MudChip Size="Size.Small" Icon="@Icons.Filled.CalendarMonth" IconColor="Color.Surface" Class="border-0 rounded-0 px-0" Style="background:transparent">@trail.Month Months</MudChip>
                        <MudChip Size="Size.Small" Icon="@Icons.Material.Filled.Percent" IconColor="Color.Surface" Class="border-0 rounded-0 px-1" Style="background:transparent">@trail.Interest Interest</MudChip>
                    </MudToolBar>

                    <MudGrid Class="px-0 d-flex">
                        <MudItem xs="6">
                            <MudButton Variant="Variant.Outlined" Class="mt-2 custom orange" IconColor="Color.Success" Size="Size.Medium" Href="@href" Style="width:100%">Apply</MudButton>
                        </MudItem>
                        <MudItem xs="6">
                            <MudButton Variant="Variant.Outlined" DisableRipple=true Class="mt-2 custom basic" IconColor="Color.Surface" Size="Size.Medium" Style="width:100%;" EndIcon="@Icons.Filled.KeyboardArrowDown" OnClick="(() => { IsVisibleProductOverlay(trail.Id); })">Details</MudButton>
                        </MudItem>
                    </MudGrid>
                    <MudOverlay Class="pa-3" Absolute="true" DarkBackground="true" @bind-Visible="@dictOverlayVisibility[trail.Id]" AutoClose=false>
                        @if (_loanLenderDto != default)
                        {
                            @if (_loanLenderDto.Product != default)
                            {
                                <MudText Typo="Typo.h1" Class="title" Style="@($"color:{Colors.Shades.White};height:auto !important;")">@_loanLenderDto.Product.Name</MudText>
                            }
                        }
                        <MudToolBar Style="height:auto">
                            <MudText Typo="Typo.h2" Class="text-left product-price" Style="@($"color:var(--mud-palette-secondary)")">@string.Format("{0:#,0.00}", _sumLoan) @_currency</MudText>
                            <MudSpacer />
                            @if (trail.LoanApplicants != default)
                            {
                                <MudAlert Severity="Severity.Normal" Icon="@Icons.Material.Filled.Person" Dense="true" Class="ma-0 pa-0 border-0" Variant="Variant.Outlined" Style="@($"color:{Colors.Shades.White}")">@trail.LoanApplicants.Count()</MudAlert>
                            }
                        </MudToolBar>
                        <MudGrid Class="pa-2" Style="height:auto">
                            <MudItem Class="pa-1" Style="@($"color:{Colors.Shades.White}")"><MudIconButton Variant="Variant.Text" Size="Size.Small" Icon="@Icons.Filled.CalendarMonth" Class="border-0 rounded-0" Style="@($"background:transparent;color:{Colors.Shades.White}")"></MudIconButton>@trail.Month Months</MudItem>
                            <MudItem Class="pa-1" Style="@($"color:{Colors.Shades.White}")"><MudIconButton Variant="Variant.Text" Size="Size.Small" Icon="@Icons.Material.Filled.Percent" Class="border-0 rounded-0" Style="@($"background:transparent;color:{Colors.Shades.White}")"></MudIconButton>@trail.Interest Interest</MudItem>
                            <MudItem Class="pa-1" Style="@($"color:{Colors.Shades.White}")"><MudIconButton Variant="Variant.Text" Size="Size.Small" Icon="@Icons.Material.Filled.Event" Class="border-0 rounded-0" Style="@($"background:transparent;color:{Colors.Shades.White}")"></MudIconButton>@string.Format("{0:dddd, MMMM d, yyyy}", trail.StartOfPayment)</MudItem>
                            <MudItem Class="pa-1" Style="@($"color:{Colors.Shades.White}")"><MudIconButton Variant="Variant.Text" Size="Size.Small" Icon="@Icons.Material.Filled.Money" Class="border-0 rounded-0" Style="@($"background:transparent;color:{Colors.Shades.White}")"></MudIconButton>Base amount: @string.Format("{0:#,0.00}", _loanLenderDto?.Product?.Amount) @_currency</MudItem>
                            <MudItem Class="pa-1" Style="@($"color:{Colors.Shades.White}")"><MudIconButton Variant="Variant.Text" Size="Size.Small" Icon="@Icons.Material.Filled.ShowChart" Class="border-0 rounded-0" Style="@($"background:transparent;color:{Colors.Shades.White}")"></MudIconButton>@trail.InterestType</MudItem>
                        </MudGrid>
                        <MudButton Variant="Variant.Outlined" DisableRipple=true Class="mt-2 custom orange" IconColor="Color.Surface" Size="Size.Medium" Style="width:100%;" OnClick="(() => { IsVisibleProductOverlay(trail.Id); })">
                            Close
                        </MudButton>
                    </MudOverlay>
                </MudCardContent>

                @* <MudCardContent Class="text-center py-0">
        <MudButton Variant="Variant.Outlined" Class="mt-2" StartIcon="@Icons.Material.Filled.PlayArrow" IconColor="Color.Success" Size="Size.Medium" Href="@href">Apply</MudButton>
        </MudCardContent>
        <MudCardContent Class="text-center pb-1">
        <MudPaper Class="text-left d-block" Elevation="0">
        <MudText Typo="Typo.caption" Class="d-inline-block" Style="font-size:10px !important; line-height:1.1em;"><MudIcon Size="Size.Small" Style="font-size:10px !important" Icon="@Icons.Material.Filled.Numbers" Title="Month" /> @trail.Month Month(s)</MudText>
        <MudText Typo="Typo.caption" Class="d-inline-block" Style="font-size:10px !important; line-height:1.1em;"><MudIcon Size="Size.Small" Style="font-size:10px !important" Icon="@Icons.Material.Filled.Percent" Title="Interest" /> @trail.Interest</MudText>
        <MudText Typo="Typo.caption" Class="d-inline-block" Style="font-size:10px !important; line-height:1.1em;"><MudIcon Size="Size.Small" Style="font-size:10px !important" Icon="@Icons.Material.Filled.Event" Title="Start of payment" /> @string.Format("{0:dddd, MMMM d, yyyy}", trail.StartOfPayment)</MudText>
        </MudPaper>
        </MudCardContent>
        <MudExpansionPanels Elevation="0">
        <MudExpansionPanel Text="More" Class="py-0" MaxHeight="250">
        <MudPaper Class="text-left d-block py-0" Elevation="0">
        <MudText Typo="Typo.caption" Class="d-block" Style="font-size:10px !important"><MudIcon Size="Size.Small" Style="font-size:10px !important" Icon="@(trail.Status.Equals(LoanStatus.Published) ? Icons.Material.Filled.Check : Icons.Material.Filled.DoNotDisturb)" Title="Status" /> @trail.Status</MudText>
        <MudText Typo="Typo.caption" Class="d-block" Style="font-size:10px !important"><MudIcon Size="Size.Small" Style="font-size:10px !important" Icon="@Icons.Material.Filled.Money" Title="Base Amount" /> Base: @string.Format("{0:#,0.00}", _loanLenderDto?.Product?.Amount) @_currency</MudText>
        <MudText Typo="Typo.caption" Class="d-block" Style="font-size:10px !important"><MudIcon Size="Size.Small" Style="font-size:10px !important" Icon="@Icons.Material.Filled.ShowChart" Title="Interest type" /> @trail.InterestType</MudText>
        </MudPaper>
        </MudExpansionPanel>
        </MudExpansionPanels>*@

            </MudCardContent>
        </MudCard>
    };
}