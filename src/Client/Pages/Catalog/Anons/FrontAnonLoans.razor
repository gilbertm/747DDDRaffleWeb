@page "/catalog/front/loans/anon"
@attribute [AllowAnonymous]
@using System.Globalization
@using EHULOG.BlazorWebAssembly.Client.Components.EntityContainer
@using EHULOG.BlazorWebAssembly.Client.Pages.Catalog.Loans
@using Nager.Country

<MudGrid>

    @if (Context is not null)
    {
        <MudItem xs="12" Class="text-center">
            <MudText Class="mb-3">
                Available loans. Closest to your <MudIcon Icon="@Icons.Material.Filled.LocationOn" Color="Color.Success" Size="Size.Small" Title="Favorite" /> location
            </MudText>
        </MudItem>
        <MudItem xs="12" md="4" lg="3" Class="pa-0">
              <DynamicMapLoad IsMapOnly=true />
        </MudItem>
        <MudItem xs="12" md="8" lg="9">
            <EntityContainer TEntity="LoanDto" Context="@Context"></EntityContainer>
        </MudItem> 
    } else
    {
        <MudItem xs="12" Class="text-center justify-content-center">
            <MudText Typo="Typo.h5" Class="mt-5" Style="@($"color:{Colors.Yellow.Darken1};")">Seems like this location isn't helping those who are in need. Be the <MudLink Href="#" Typo="Typo.h5" Class="mt-5" Color="Color.Primary">first</MudLink>?</MudText>
        </MudItem>        
    }

</MudGrid>

@code {

    protected RenderFragment<LoanDto> BodyTemplate => trail => __builder =>
    {
        LoanLesseeDto _loanLesseeDto = default!;
        LoanLenderDto _loanLenderDto = default!;
        List<LoanLedgerDto> _loanLedgers = default!;
        float _sumLoan = 0f;
        string _currency = string.Empty;

        string _imageUrl = string.Empty;
        string _productName = string.Empty;
        string href = "/loan/" + @trail.Id + "?redirect_url=/login";

        if (trail.LoanLenders is { })
        {
            _loanLenderDto = trail.LoanLenders?.FirstOrDefault() ?? default!;
            _imageUrl = string.IsNullOrEmpty(trail.LoanLenders?.FirstOrDefault()?.Product?.Image?.ImagePath) ? string.Empty : (Config[ConfigNames.ApiBaseUrl] + trail.LoanLenders?.First().Product?.Image?.ImagePath);
            _productName = trail.LoanLenders?.FirstOrDefault()?.Product?.Name ?? string.Empty;
            var regions = CultureInfo.GetCultures(CultureTypes.SpecificCultures).Select(x => new RegionInfo(x.LCID));

            if (_loanLenderDto is { } && !(_loanLenderDto.LenderId == default))
            {
                if (_loanLenderDto.Lender is { } && !string.IsNullOrEmpty(_loanLenderDto.Lender.HomeCountry))
                {
                    var countryProvider = new CountryProvider();
                    var countryInfo = countryProvider.GetCountryByName(_loanLenderDto.Lender.HomeCountry);

                    if (countryInfo is { })
                    {
                        if (countryInfo.Currencies.Count() > 0)
                        {
                            _currency = countryInfo.Currencies.FirstOrDefault()?.IsoCode ?? string.Empty;
                        }

                    }
                }
            }
        }

        if (trail.LoanLessees is { })
        {
            _loanLesseeDto = trail.LoanLessees?.Where(l => l.LoanId.Equals(trail.Id)).FirstOrDefault() ?? default!;
        }

        if (trail.Ledgers is { })
        {
            _loanLedgers = trail.Ledgers?.ToList() ?? default!;

            if (!(_loanLedgers.Equals(default)))
            {
                _sumLoan = _loanLedgers.Sum(l => l.AmountDue);
            }
        }


        <MudCard>

            <MudCardContent>

                <MudCardContent>
                    <MudImage Fluid="true" Src="@_imageUrl" Alt="@_productName" Class="rounded-lg" />
                </MudCardContent>
                <MudCardContent Class="text-center py-0">
                    @if (trail.LoanApplicants is { })
                    {
                        <MudText Typo="Typo.caption" Class="d-block" Style="font-size:12px !important"><MudIcon Size="Size.Small" Style="font-size:12px !important" Icon="@Icons.Material.Filled.Person" Title="Status" /> @trail.LoanApplicants.Count()</MudText>
                    }
                </MudCardContent>
                <MudCardContent Class="text-center py-0">
                    <MudText Typo="Typo.h6" Color="Color.Primary">@trail.LoanLenders?.FirstOrDefault()?.Product?.Name</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Success">@string.Format("{0:#,0.00}", _sumLoan) @_currency</MudText>
                    <MudButton Variant="Variant.Outlined" Class="mt-2" StartIcon="@Icons.Material.Filled.PlayArrow" IconColor="Color.Success" Size="Size.Medium" Href="@href">Apply</MudButton>
                </MudCardContent>
                <MudCardContent Class="text-center pb-1">
                    <MudPaper Class="text-left d-block" Elevation="0">
                        <MudText Typo="Typo.caption" Class="d-inline-block" Style="font-size:10px !important; line-height:1.1em;"><MudIcon Size="Size.Small" Style="font-size:10px !important" Icon="@Icons.Material.Filled.Numbers" Title="Month" /> @trail.Month Month(s)</MudText>
                        <MudText Typo="Typo.caption" Class="d-inline-block" Style="font-size:10px !important; line-height:1.1em;"><MudIcon Size="Size.Small" Style="font-size:10px !important" Icon="@Icons.Material.Filled.Percent" Title="Interest" /> @trail.Interest</MudText>
                        <MudText Typo="Typo.caption" Class="d-inline-block" Style="font-size:10px !important; line-height:1.1em;"><MudIcon Size="Size.Small" Style="font-size:10px !important" Icon="@Icons.Material.Filled.Event" Title="Start of payment" /> @string.Format("{0:dddd, MMMM d, yyyy}", trail.StartOfPayment)</MudText>
                    </MudPaper>
                </MudCardContent>
                <MudExpansionPanels Elevation="0">
                    <MudExpansionPanel Text="More" Class="py-0" MaxHeight="250">
                        <MudPaper Class="text-left d-block py-0" Elevation="0">
                            <MudText Typo="Typo.caption" Class="d-block" Style="font-size:10px !important"><MudIcon Size="Size.Small" Style="font-size:10px !important" Icon="@(trail.Status.Equals(LoanStatus.Published) ? Icons.Material.Filled.Check : Icons.Material.Filled.DoNotDisturb)" Title="Status" /> @trail.Status</MudText>
                            <MudText Typo="Typo.caption" Class="d-block" Style="font-size:10px !important"><MudIcon Size="Size.Small" Style="font-size:10px !important" Icon="@Icons.Material.Filled.Money" Title="Base Amount" /> Base: @string.Format("{0:#,0.00}", _loanLenderDto?.Product?.Amount) @_currency</MudText>
                            <MudText Typo="Typo.caption" Class="d-block" Style="font-size:10px !important"><MudIcon Size="Size.Small" Style="font-size:10px !important" Icon="@Icons.Material.Filled.ShowChart" Title="Interest type" /> @trail.InterestType</MudText>
                        </MudPaper>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudCardContent>
        </MudCard>
    };
}