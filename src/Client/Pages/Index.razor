@page "/home"
@page "/"
@using Nager.Country;
@using EHULOG.BlazorWebAssembly.Client.Pages.Catalog.Anons;

@attribute [AllowAnonymous]

@if (!_isAuthenticated)
{
    <FrontAnonLoans />
}

<LossGeolocationPopup />

@code {

    [Inject]
    protected AuthenticationStateProvider AuthenticationStateProvider { get; set; } = default!;

    [Inject]
    protected AppDataService AppDataService { get; set; } = default!;

    private bool _isAuthenticated { get; set; } = false;

    private string _currency { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        await AppDataService.InitializationAsync();

        if (AppDataService != default)
        {
            if (AppDataService.AppUser != default)
            {
                if (!string.IsNullOrEmpty(AppDataService.AppUser.RoleName) && AppDataService.AppUser.RoleName.Equals("Lender"))
                {
                    Navigation.NavigateTo("/loans/lender");
                }
                else
                {
                    if (!string.IsNullOrEmpty(AppDataService.AppUser.HomeCountry))
                    {
                        var countryProvider = new CountryProvider();
                        var countryInfo = countryProvider.GetCountryByName(AppDataService.AppUser.HomeCountry);

                        if (countryInfo is { })
                        {
                            if (countryInfo.Currencies.Count() > 0)
                            {
                                _currency = countryInfo.Currencies.FirstOrDefault()?.IsoCode ?? string.Empty;
                            }
                        }
                    }

                    if (AppDataService.AppUser.RolePackageStatus != default)
                    {
                        if (AppDataService.AppUser.RolePackageStatus < VerificationStatus.Submitted)
                        {
                            Navigation.NavigateTo("/account/role-subscription");
                        }
                        else
                        {
                            Navigation.NavigateTo("/loans/lessee");
                        }
                    }
                }
            }
        }
    }

}